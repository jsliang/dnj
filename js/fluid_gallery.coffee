img_info_items = {
'000_0df0a0fb5e36f0c47c97fb068c58912a': {"path": "https://lh4.googleusercontent.com/-92SL2LrB8j0/UfdYn7z52II/AAAAAAACRhk/tvCJMTlTDKo/s800/P_20130726_145305.jpg", "height": 1536, "width": 2048},
'001_2c53d68da91984bd05e08074e2044fd6': {"path": "https://lh3.googleusercontent.com/-uInONJ_0i5Y/UfdYn32glNI/AAAAAAACRdA/nJpSAPt2EVk/s800/P_20130726_172519.jpg", "height": 2048, "width": 1536},
'002_5c2f8bd60317f30e8a947e6c6ab32739': {"path": "https://lh6.googleusercontent.com/-NjCC0JDS4Z8/UfdYn2YfZxI/AAAAAAACRdA/BTVJcjHSjFU/s800/P_20130726_173556.jpg", "height": 2048, "width": 1536},
'003_bd5444accfccbe27bcee9583790df4ee': {"path": "https://lh4.googleusercontent.com/-JxGh8fcxf0E/UfdYn3JV6vI/AAAAAAACRg8/ixOZejb_fJQ/s800/P_20130726_180934.jpg", "height": 1324, "width": 2048},
'004_193d9664a04b6e21d9d96ccf3491c117': {"path": "https://lh5.googleusercontent.com/-Y88zoJuiGSs/UfdYn-MiSMI/AAAAAAACRdA/tq2vZxyqwPc/s800/P_20130726_181402.jpg", "height": 2048, "width": 1536},
'005_4fe347348d76814e16eb9f7ff5eb5d99': {"path": "https://lh4.googleusercontent.com/-z1dlQKHD8jg/UfdYn4NleJI/AAAAAAACRdA/mwBW7pHLOuk/s800/P_20130726_181418.jpg", "height": 1536, "width": 2048},
'006_389ceb56ddfa1668e4e0199737d325a4': {"path": "https://lh3.googleusercontent.com/-WjTqYAg71CU/UfdYnwFkrPI/AAAAAAACRdE/q3bGYEl8BI0/s800/P_20130726_181430.jpg", "height": 1536, "width": 2048},
'007_83b1aa8c771bcfce4ad78447c86a2c9d': {"path": "https://lh5.googleusercontent.com/-Qco1syLQYcE/UfdYn0Uus9I/AAAAAAACRhE/9hUlVSyWrmI/s800/P_20130726_182002.jpg", "height": 1226, "width": 2048},
'008_6533341dbd6fccd798e5b7b7688026e7': {"path": "https://lh3.googleusercontent.com/-ACdY_BLHY0Y/UfdYnyaYbJI/AAAAAAACRhw/Td2mPn4Od0A/s800/P_20130726_185245.jpg", "height": 2048, "width": 1536},
'009_9920742bb10ba456b47a74bd708af4ca': {"path": "https://lh3.googleusercontent.com/-Kke25Xz2S_I/UfdYn1Mw7BI/AAAAAAACRhw/56q4ipdbPa4/s800/P_20130726_190933.jpg", "height": 2048, "width": 1536},
'010_db8db00b1a461dc37ad952f79c5bd0b9': {"path": "https://lh4.googleusercontent.com/-XCI7C_axGSs/UfdYn-e9aFI/AAAAAAACRhw/adP7JHMVaA4/s800/P_20130728_125106.jpg", "height": 1536, "width": 2048},
'011_d00a16988521e42545abb37d9779baf2': {"path": "https://lh3.googleusercontent.com/-tkJARKSXScQ/UfdYnzbo6hI/AAAAAAACRhw/-5XH54euQUQ/s800/P_20130728_125118.jpg", "height": 1536, "width": 2048},
'012_19d29a1581d1622a51ad93b43985020b': {"path": "https://lh3.googleusercontent.com/-9b38l9F_Ar0/UfdYnzykRpI/AAAAAAACRhM/wU7YOTM7-eQ/s800/P_20130728_133143.jpg", "height": 1536, "width": 2048},
'013_a291dd627cb0a62dc1d01ca340e36bfc': {"path": "https://lh3.googleusercontent.com/-ceA-uNnKVG0/UfdYn394NbI/AAAAAAACRhw/8cVR0LDKDMY/s800/P_20130728_133553.jpg", "height": 1536, "width": 2048},
'014_58c52fb9831db932b07dcbf299ec4caa': {"path": "https://lh5.googleusercontent.com/-ybsWmGmdgQ8/UfdYn6XCW3I/AAAAAAACRhw/zE7Xvt_W8qk/s800/P_20130728_134840.jpg", "height": 2048, "width": 1536},
'015_5494aa8b1a75fc7e54346e0cf3dc2107': {"path": "https://lh4.googleusercontent.com/-DzfxSfzeZzY/UfdYn8E5LVI/AAAAAAACRkY/uU8Vt47mv4I/s800/P_20130729_100441.jpg", "height": 1536, "width": 2048},
'016_5c7ed8ed2133de368ec95bc210d908ed': {"path": "https://lh6.googleusercontent.com/-vcxTLZtD6sk/UfdYn79LcuI/AAAAAAACRkY/cU6ux6-msCM/s800/P_20130729_100457.jpg", "height": 1536, "width": 2048},
'017_ba0d8e385ddda07187c62c3fbea45924': {"path": "https://lh4.googleusercontent.com/-D2kzMMikysg/UfdYn1Xx0FI/AAAAAAACRkY/HGiClzJIewQ/s800/P_20130729_100515.jpg", "height": 1536, "width": 2048},
'018_453ee114c296b455be39cffc2d0dc555': {"path": "https://lh6.googleusercontent.com/-xw0kh0RjI5k/UfdYn9-r_jI/AAAAAAACRhw/v6ZUeIIMTNI/s800/P_20130729_123351.jpg", "height": 1536, "width": 2048},
'019_b3853de372a12f25878076b21a47bb92': {"path": "https://lh3.googleusercontent.com/-0q_PmxXTnx8/UfdYn8i8KBI/AAAAAAACRdA/PXM5okSjaSs/s800/P_20130729_130722.jpg", "height": 1536, "width": 2048},
'020_d4f30b4407f974962b59456f830dec53': {"path": "https://lh4.googleusercontent.com/-tCwB5VUn-ZQ/UfdYn6E5GeI/AAAAAAACRhw/0I19LuZZ0QA/s800/P_20130729_162603.jpg", "height": 1536, "width": 2048},
'021_859f4da4f6df0ef7e0946959b7b90cdc': {"path": "https://lh4.googleusercontent.com/-8y_kDv_rgD4/UfdYnx3JqNI/AAAAAAACRhw/y3Lk-ca8UAA/s800/P_20130729_171837.jpg", "height": 1536, "width": 2048},
}

$ = jQuery

$.fn.extend
    gallery: (img_info_items, option = {min_height: 200, margin: 6})->
        gallery = $(this)

        img_gallery = for img_id, img_info of img_info_items
            gallery.append("<img id='#{ img_id }' src='#{ img_info.path }' />")

            $("#" + img_id).data("orig_width", img_info.width)
            $("#" + img_id).data("orig_height", img_info.height)
            $("#" + img_id).css("margin", option.margin / 2)

            $("#" + img_id)._setHeight(option.min_height)

        gallery._relayout(img_info_items, option)

        $(window).resize ()->
            gallery.children("img").each ()->
                $(this)._setHeight(option.min_height)
            gallery._relayout(img_info_items, option)

    _setHeight: (height)->
        orig_width = $(this).data("orig_width")
        orig_height = $(this).data("orig_height")

        width = height / orig_height * orig_width

        if width < orig_width and height < orig_height
            $(this).width(width).height(height)

    _resizeImage: (ratio)->
        orig_width = $(this).data("orig_width")
        orig_height = $(this).data("orig_height")
        current_width = $(this).width()
        current_height = $(this).height()
        new_width = current_width * ratio
        new_height = current_height * ratio

        if new_width < orig_width and new_height < orig_height
            $(this).width(new_width).height(new_height)

    _relayout: (img_info_items, option)->
        max_total_width = $(this).innerWidth() - 10

        rows = {}
        $(this).children("img").each ()->
            top = $(this).position().top
            if rows[top]?
                rows[top].push $(this).attr("id")
            else
                rows[top] = [ $(this).attr("id") ]

        stretch_row = for row_top, img_id_list of rows
            # calculate current_total_width
            current_total_width = 0
            for img_id in img_id_list
                do (img_id)->
                    current_total_width += $("#" + img_id).width()

            # caculate resize ratio
            resize_ratio = (max_total_width - option.margin * (img_id_list.length - 1)) / current_total_width

            # resize images of this row according to resize_ratio
            for img_id in img_id_list
                do (img_id)->
                    $("#" + img_id)._resizeImage(resize_ratio)

$(document).ready ()->
    $("#gallery").gallery(img_info_items)